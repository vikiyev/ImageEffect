# Image Effects

This WebAssembly project applies a grayscale filter to an image.

# WebAssembly

WebAssembly is a language for the web to run apps at near native speeds. WebAssembly is a compilation target, which is a language targeted by a compiler.

# Rust

Rust is a statically typed, memory safe and highly performant language. Rust provides the following tools:

- rustup - managing different versions of Rust
- rustc - tool for compiling Rust code
- cargo - tool for managing Rust packages and projects

## Webpack

Webpack is used for minifying and bundling our assets. It can also be used to compile rust projects. We use the following libraries for the project: `webpack webpack-cli webpack-dev-server html-webpack-plugin`. For html bundling, we use webpack-create-html. Since Rust doesn't run on the browser, it needs to be compiled into wasm using `@wasm-tool/wasm-pack-plugin wasm-pack`.

We create a `webpack.config.js` file.

```javascript
const path = require("path");
const HTMLWebpackPlugin = require("html-webpack-plugin");
const WasmPackPlugin = require("@wasm-tool/wasm-pack-plugin");

module.exports = {
  entry: "./public/main.js",
  output: {
    path: path.resolve(__dirname, "dist"),
    filename: "index.js",
  },
  plugins: [
    new HTMLWebpackPlugin({
      template: "./public/index.html",
    }),
    new WasmPackPlugin({
      crateDirectory: path.resolve(__dirname, "."),
    }),
  ],
};
```

```json
  "scripts": {
    "serve": "webpack serve --mode=development",
    "build": "webpack --mode=production"
  },
```

We also need to tell rust to support external languages using the **lib** table.

```toml
[package]
name = "wasm"
version = "0.1.0"
edition = "2021"

[lib]
crate-type = ["cdylib"]

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[dependencies]
```

## Reading Files

We need to be able to send images from javascript to rust. We can do so by intercepting file uploads using events. We can convert from binary file into a string using FileReader.**readAsDataURL** which we will transfer to rust.

```javascript
function init() {
  const input = document.getElementById("upload");
  const fileReader = new FileReader();

  input.addEventListener("change", () => {
    fileReader.readAsDataURL(input.files[0]);

    fileReader.onloadend = () => {
      // remove metadata from the result
      const base64 = fileReader.result.replace(
        /^data:image\/(png|jpeg|jpg);base64,/,
        ""
      );
      console.log(input.files[0]);
      console.log(base64);
    };
  });
}

init();
```

## Importing Web Assembly

To import the wasm file generated by webpack, we use the `wasm-bindgen` crate which helps us export rust functions into javascript. We can add the following to the dependencies table of the `cargo.toml` file:

```toml
wasm-bindgen = "0.2.83"
```
